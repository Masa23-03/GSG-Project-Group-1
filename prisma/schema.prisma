generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

enum UserRole {
  PATIENT
  PHARMACY
  DRIVER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum VerificationStatus {
  UNDER_REVIEW
  VERIFIED
  REJECTED
}

enum AvailabilityStatus {
  ONLINE
  OFFLINE
}

enum MedicineStatus {
  APPROVED
  PENDING
  REJECTED
}

enum PrescriptionStatus {
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum OrderStatus {
  PENDING
  PARTIALLY_ACCEPTED
  ACCEPTED
  PROCESSING
  OUT_FOR_DELIVERY
  DELIVERED
  REJECTED
  CANCELLED
}

enum DeliveryType {
  STANDARD
  EXPRESS
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  PICKUP_IN_PROGRESS
  EN_ROUTE
  DELIVERED
}

enum DeliveryConfirmationMethod {
  PHOTO
  OTP
}

enum PaymentMethod {
  COD
  CREDIT_CARD
}

enum PaymentStatus {
  PENDING

  PAID

  FAILED

  REFUNDED
}

enum PharmacyOrderStatus {
  PENDING
  ACCEPTED
  REJECTED
  PREPARING
  READY_FOR_PICKUP
  //at least one pharmacy status is READY_FOR_PICKUP -> into delivery
  PICKED_UP
  COMPLETED
}

enum Currency {
  ILS
  USD
  JOD
}

model RefreshToken {
  id        Int       @id @default(autoincrement()) @db.UnsignedInt
  userId    Int       @db.UnsignedInt
  token     String    @unique @db.VarChar(255)
  expiresAt DateTime  @map("expires_at") @db.Timestamp()
  revokedAt DateTime? @map("revoked_at") @db.Timestamp()
  createdAt DateTime  @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId], map: "idx_tokens_user")
  @@map("refresh_tokens")
}

model User {
  id              Int        @id @default(autoincrement()) @db.UnsignedInt
  email           String     @unique @db.VarChar(255)
  password        String     @db.VarChar(255)
  role            UserRole   @default(PATIENT)
  status          UserStatus @default(ACTIVE) //flag
  name            String     @db.VarChar(255)
  phoneNumber     String     @map("phone_number") @db.VarChar(255)
  dateOfBirth     DateTime?  @db.Date()
  profileImageUrl String?    @map("profile_image_url") @db.VarChar(255)
  createdAt       DateTime   @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt       DateTime   @updatedAt @map("updated_at") @db.DateTime(0)
  //createdBy  :by admin or self

  //! Relations
  pharmacy           Pharmacy?        @relation("PharmacyOwner")
  verifiedPharmacies Pharmacy[]       @relation("PharmacyVerifier")
  driver             Driver?          @relation("DriverOwner")
  verifiedDrivers    Driver[]         @relation("DriverVerifier")
  addresses          PatientAddress[]
  orders             Order[]
  refreshToken       RefreshToken[]

  @@index([role], map: "idx_users_role")
  @@index([status], map: "idx_users_status")
  @@map("users")
}

model Pharmacy {
  id                 Int                @id @default(autoincrement()) @db.UnsignedInt
  userId             Int                @unique @db.UnsignedInt
  reviewedBy         Int?               @db.UnsignedInt
  pharmacyName       String             @map("pharmacy_name") @db.VarChar(255)
  licenseNumber      String             @unique @map("license_number") @db.VarChar(255)
  licenseDocumentUrl String?            @map("license_document_url") @db.VarChar(255)
  cityId             Int                @db.UnsignedInt
  address            String?            @db.Text
  latitude           Decimal?           @db.Decimal(10, 8)
  longitude          Decimal?           @db.Decimal(11, 8)
  coverImageUrl      String?            @map("cover_image_url") @db.VarChar(255)
  verificationStatus VerificationStatus @default(UNDER_REVIEW) @map("verification_status")
  reviewedAt         DateTime?          @map("verified_at") @db.Timestamp()
  workOpenTime       DateTime?          @map("work_open_time") @db.Time()
  workCloseTime      DateTime?          @map("work_close_time") @db.Time()
  avgPrepTimeMinutes Int                @default(10) @map("avg_prep_time_minutes") @db.TinyInt
  createdAt          DateTime           @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt          DateTime           @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  // owner (1–1)
  user           User            @relation("PharmacyOwner", fields: [userId], references: [id])
  // verifier (admin, 1–many)
  admin          User?           @relation("PharmacyVerifier", fields: [reviewedBy], references: [id])
  inventoryItems InventoryItem[]
  pharmacyOrders PharmacyOrder[]
  city           City            @relation(fields: [cityId], references: [id])

  @@index([verificationStatus], map: "idx_pharmacies_verified")
  @@map("pharmacies")
}

model Driver {
  id                 Int                @id @default(autoincrement()) @db.UnsignedInt
  userId             Int                @unique @db.UnsignedInt
  verifiedBy         Int?               @db.UnsignedInt
  verifiedAt         DateTime?          @map("verified_at") @db.Timestamp()
  vehicleName        String             @map("vehicle_name") @db.VarChar(255)
  vehiclePlate       String             @unique @map("vehicle_plate") @db.VarChar(255)
  licenseDocumentUrl String             @map("license_document_url") @db.VarChar(255)
  availabilityStatus AvailabilityStatus @default(OFFLINE) @map("availability_status")
  verificationStatus VerificationStatus @default(UNDER_REVIEW) @map("verification_status")
  lastLatitude       Decimal?           @map("last_latitude") @db.Decimal(10, 8)
  lastLongitude      Decimal?           @map("last_longitude") @db.Decimal(11, 8)
  licenseNumber      String?            @unique @map("license_number") @db.VarChar(255)
  lastLocationAt     DateTime?          @map("last_location_at") @db.Timestamp()
  createdAt          DateTime           @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt          DateTime           @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  user       User       @relation("DriverOwner", fields: [userId], references: [id])
  admin      User?      @relation("DriverVerifier", fields: [verifiedBy], references: [id])
  deliveries Delivery[]

  @@index([verificationStatus], map: "idx_drivers_verified")
  @@index([availabilityStatus], map: "idx_drivers_availability")
  @@map("drivers")
}

model Delivery {
  id                   Int                         @id @default(autoincrement()) @db.UnsignedInt
  orderId              Int                         @unique @map("order_id") @db.UnsignedInt
  driverId             Int?                        @map("driver_id") @db.UnsignedInt
  status               DeliveryStatus              @default(PENDING)
  confirmationMethod   DeliveryConfirmationMethod? @map("confirmation_method")
  confirmationPhotoUrl String?                     @map("confirmation_photo_url") @db.VarChar(255)
  confirmationOtpHash  String?                     @map("confirmation_otp_hash") @db.VarChar(255)

  createdAt   DateTime  @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.DateTime(0)
  acceptedAt  DateTime? @map("accepted_at") @db.DateTime(0)
  deliveredAt DateTime? @map("delivered_at") @db.DateTime(0)

  //! Relations
  order          Order           @relation("OrderDelivery", fields: [orderId], references: [id])
  driver         Driver?         @relation(fields: [driverId], references: [id])
  pharmacyOrders PharmacyOrder[]

  @@index([driverId], map: "idx_deliveries_driver")
  @@index([status], map: "idx_deliveries_status")
  @@map("deliveries")
}

model PatientAddress {
  id           Int      @id @default(autoincrement()) @db.UnsignedInt
  userId       Int      @db.UnsignedInt
  label        String?  @db.VarChar(255)
  area         String?  @db.VarChar(255)
  region       String?  @db.VarChar(255)
  country      String?  @db.VarChar(255)
  addressLine1 String   @db.Text
  addressLine2 String?  @db.Text
  latitude     Decimal? @db.Decimal(10, 8)
  longitude    Decimal? @db.Decimal(11, 8)
  isDefault    Boolean  @default(false) @map("is_default")
  isDeleted    Boolean  @default(false) @map("is_deleted")
  createdAt    DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.DateTime(0)
  //! Relations
  user         User     @relation(fields: [userId], references: [id])
  orders       Order[]

  @@index([userId], map: "idx_addresses_user")
  @@map("patient_addresses")
}

model CityDeliveryFee {
  id                Int      @id @default(autoincrement()) @db.UnsignedInt
  cityId            Int      @unique @db.UnsignedInt
  standardFeeAmount Decimal  @default(0) @map("standard_fee_amount") @db.Decimal(10, 2)
  expressFeeAmount  Decimal? @map("express_fee_amount") @db.Decimal(10, 2)
  currency          Currency @default(ILS)
  createdAt         DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.DateTime(0)
  //! Relations
  city              City     @relation(fields: [cityId], references: [id])

  @@map("city_delivery_fees")
}

model City {
  id   Int    @id @default(autoincrement()) @db.UnsignedInt
  name String @unique

  cityDeliveryFee CityDeliveryFee?
  pharmacies      Pharmacy[]
  orders          Order[]
}

model Category {
  id               Int      @id @default(autoincrement()) @db.UnsignedInt
  name             String   @db.VarChar(255)
  categoryImageUrl String?  @db.VarChar(255)
  description      String?  @db.MediumText
  createdAt        DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  medicines Medicine[]

  @@index([name], map: "idx_categories_name")
  @@map("categories")
}

model Medicine {
  id                   Int             @id @default(autoincrement()) @db.UnsignedInt
  categoryId           Int             @map("category_id") @db.UnsignedInt
  genericName          String          @map("generic_name") @db.VarChar(255)
  brandName            String?         @map("brand_name") @db.VarChar(255)
  manufacturer         String?         @db.VarChar(255)
  dosageForm           String?         @map("dosage_form") @db.VarChar(255)
  strengthValue        Decimal?        @map("strength_value") @db.Decimal(10, 7)
  strengthUnit         String?         @map("strength_unit") @db.VarChar(255)
  packSize             Int?            @map("pack_size") @db.Int
  packUnit             String?         @map("pack_unit") @db.VarChar(255)
  requiresPrescription Boolean         @default(false) @map("requires_prescription")
  activeIngredients    String?         @map("active_ingredients") @db.LongText
  dosageInstructions   String?         @map("dosage_instructions") @db.LongText
  storageInstructions  String?         @map("storage_instructions") @db.LongText
  warnings             String?         @db.LongText
  description          String          @db.LongText
  status               MedicineStatus  @default(PENDING)
  isActive             Boolean         @default(true) @map("is_active")
  maxPrice             Decimal?        @map("max_price") @db.Decimal(10, 8)
  createdAt            DateTime        @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt            DateTime        @updatedAt @map("updated_at") @db.DateTime(0)
  //! Relations
  category             Category        @relation(fields: [categoryId], references: [id])
  medicineImages       MedicineImage[]
  inventoryItems       InventoryItem[]

  @@index([categoryId, isActive, status], map: "idx_medicines_category_active_status")
  @@index([genericName], map: "idx_medicines_generic_name")
  @@index([brandName], map: "idx_medicines_brand_name")
  @@map("medicines")
}

model MedicineImage {
  id         Int      @id @default(autoincrement()) @db.UnsignedInt
  medicineId Int      @map("medicine_id") @db.UnsignedInt
  url        String   @db.VarChar(255)
  sortOrder  Int      @map("sort_order") @db.TinyInt
  createdAt  DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  medicine Medicine @relation(fields: [medicineId], references: [id])

  @@unique([medicineId, sortOrder], map: "uq_medicine_images_medicine_sort")
  @@index([medicineId], map: "idx_medicine_images_medicine_id")
  @@map("medicine_images")
}

model InventoryItem {
  id                 Int                 @id @default(autoincrement()) @db.UnsignedInt
  pharmacyId         Int                 @map("pharmacy_id") @db.UnsignedInt
  medicineId         Int                 @map("medicine_id") @db.UnsignedInt
  createdAt          DateTime            @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt          DateTime            @updatedAt @map("updated_at") @db.DateTime(0)
  stockQuantity      Int                 @default(0) @map("stock_quantity") @db.Int
  minStock           Int                 @default(0) @map("min_stock") @db.Int
  sellPrice          Decimal             @map("sell_price") @db.Decimal(10, 8)
  costPrice          Decimal?            @map("cost_price") @db.Decimal(10, 8)
  batchNumber        String?             @map("batch_number") @db.VarChar(255)
  expiryDate         DateTime?           @map("expiry_date") @db.Date
  isAvailable        Boolean             @default(true) @map("is_available")
  notes              String?             @db.LongText
  shelfLocation      String?             @map("shelf_location") @db.VarChar(255)
  isDeleted          Boolean             @default(false) @map("is_deleted")
  //! Relations
  medicine           Medicine            @relation(fields: [medicineId], references: [id])
  pharmacy           Pharmacy            @relation(fields: [pharmacyId], references: [id])
  pharmacyOrderItems PharmacyOrderItem[]

  @@unique([pharmacyId, medicineId], map: "uq_inventory_pharmacy_medicine")
  @@index([pharmacyId], map: "idx_inventory_pharmacy")
  @@index([medicineId], map: "idx_inventory_medicine")
  @@index([pharmacyId, expiryDate], map: "idx_inventory_pharmacy_expiry")
  @@map("inventory_items")
}

model Order {
  id        Int  @id @default(autoincrement()) @db.UnsignedInt
  patientId Int  @map("patient_id") @db.UnsignedInt
  addressId Int? @map("address_id") @db.UnsignedInt

  deliveryCityId      Int     @map("delivery_city_id") @db.UnsignedInt
  deliveryArea        String? @map("delivery_area") @db.VarChar(255)
  deliveryAddressLine String  @map("delivery_address_line") @db.Text

  contactName            String   @map("contact_name") @db.VarChar(255)
  contactPhone           String   @map("contact_phone") @db.VarChar(255)
  subtotalAmount         Decimal  @map("subtotal_amount") @db.Decimal(10, 2)
  originalSubtotalAmount Decimal? @map("original_subtotal_amount") @db.Decimal(10, 2)
  discountAmount         Decimal  @default(0) @map("discount_amount") @db.Decimal(10, 2)
  deliveryFeeAmount      Decimal  @default(0) @map("delivery_fee_amount") @db.Decimal(10, 2)
  totalAmount            Decimal  @map("total_amount") @db.Decimal(10, 2)
  originalTotalAmount    Decimal? @map("original_total_amount") @db.Decimal(10, 2)
  currency               Currency @default(ILS)

  itemsCount         Int          @map("items_count") @db.Int
  originalItemsCount Int?         @map("original_items_count") @db.Int
  status             OrderStatus  @default(PENDING)
  deliveryType       DeliveryType @default(STANDARD) @map("delivery_type")
  notes              String?      @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt DateTime @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  patient        User            @relation(fields: [patientId], references: [id])
  address        PatientAddress? @relation(fields: [addressId], references: [id])
  delivery       Delivery?       @relation("OrderDelivery")
  orderCity      City            @relation(fields: [deliveryCityId], references: [id])
  payment        Payment?
  pharmacyOrders PharmacyOrder[]

  @@index([patientId, status], map: "idx_orders_patient_status")
  @@index([createdAt], map: "idx_orders_created_at")
  @@map("orders")
}

model Payment {
  id        Int           @id @default(autoincrement()) @db.UnsignedInt
  orderId   Int           @unique @map("order_id") @db.UnsignedInt
  amount    Decimal       @db.Decimal(10, 2)
  currency  Currency      @default(ILS)
  status    PaymentStatus @default(PENDING)
  createdAt DateTime      @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt DateTime      @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  order Order @relation(fields: [orderId], references: [id])

  @@index([status], map: "idx_payments_status")
  @@map("payments")
}

model PharmacyOrder {
  id                   Int                 @id @default(autoincrement()) @db.UnsignedInt
  orderId              Int                 @map("order_id") @db.UnsignedInt
  pharmacyId           Int                 @map("pharmacy_id") @db.UnsignedInt
  deliveryId           Int?                @map("delivery_id") @db.UnsignedInt
  status               PharmacyOrderStatus @default(PENDING)
  pickupOrder          Int?                @map("pickup_order") @db.SmallInt
  pickedUpAt           DateTime?           @map("picked_up_at") @db.Timestamp()
  requiresPrescription Boolean             @map("requires_prescription")
  subtotalAmount       Decimal             @map("subtotal_amount") @db.Decimal(10, 2)
  currency             Currency            @default(ILS)
  acceptedAt           DateTime?           @map("accepted_at") @db.Timestamp()
  rejectedAt           DateTime?           @map("rejected_at") @db.Timestamp()
  createdAt            DateTime            @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt            DateTime            @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  order              Order               @relation(fields: [orderId], references: [id])
  pharmacy           Pharmacy            @relation(fields: [pharmacyId], references: [id])
  delivery           Delivery?           @relation(fields: [deliveryId], references: [id])
  pharmacyOrderItems PharmacyOrderItem[]
  prescriptions      Prescription[]

  @@unique([orderId, pharmacyId], map: "uq_pharmacy_orders_order_pharmacy")
  @@index([orderId], map: "idx_pharmacy_orders_order")
  @@index([pharmacyId, status], map: "idx_pharmacy_orders_pharmacy_status")
  @@index([deliveryId], map: "idx_pharmacy_orders_delivery")
  @@map("pharmacy_orders")
}

model PharmacyOrderItem {
  id              Int      @id @default(autoincrement()) @db.UnsignedInt
  pharmacyOrderId Int      @map("pharmacy_order_id") @db.UnsignedInt
  inventoryItemId Int      @map("inventory_item_id") @db.UnsignedInt
  quantity        Int      @db.Int
  pricePerItem    Decimal  @map("price_per_item") @db.Decimal(10, 7)
  total           Decimal  @db.Decimal(10, 7)
  currency        Currency @default(ILS)

  createdAt DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt DateTime @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  pharmacyOrder PharmacyOrder @relation(fields: [pharmacyOrderId], references: [id])
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])

  @@unique([pharmacyOrderId, inventoryItemId], map: "uq_pharmacy_order_items_order_inventory")
  @@index([pharmacyOrderId], map: "idx_pharmacy_order_items_order")
  @@index([inventoryItemId], map: "idx_pharmacy_order_items_inventory")
  @@map("pharmacy_order_items")
}

model Prescription {
  id                  Int                @id @default(autoincrement()) @db.UnsignedInt
  pharmacyOrderId     Int                @map("pharmacy_order_id") @db.UnsignedInt
  status              PrescriptionStatus @default(UNDER_REVIEW)
  reuploadReason      String?            @map("reupload_reason") @db.Text
  reuploadRequestedAt DateTime?          @map("reupload_requested_at") @db.Timestamp()
  createdAt           DateTime           @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt           DateTime           @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  pharmacyOrder     PharmacyOrder      @relation(fields: [pharmacyOrderId], references: [id])
  prescriptionFiles PrescriptionFile[]

  @@index([pharmacyOrderId], map: "idx_prescriptions_pharmacy_order")
  @@index([status], map: "idx_prescriptions_status")
  @@map("prescriptions")
}

model PrescriptionFile {
  id Int @id @default(autoincrement()) @db.UnsignedInt

  prescriptionId Int    @map("prescription_id") @db.UnsignedInt
  url            String @db.VarChar(255)
  sortOrder      Int    @map("sort_order") @db.SmallInt

  createdAt DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt DateTime @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  prescription Prescription @relation(fields: [prescriptionId], references: [id])

  @@index([prescriptionId], map: "idx_prescription_files_prescription")
  @@index([prescriptionId, sortOrder], map: "idx_prescription_files_order")
  @@map("prescription_files")
}
