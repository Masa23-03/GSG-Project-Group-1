generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

enum UserRole {
  PATIENT
  PHARMACY
  DRIVER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum VerificationStatus {
  UNDER_REVIEW
  VERIFIED
  REJECTED
}

enum AvailabilityStatus {
  ONLINE
  OFFLINE
}

enum MedicineStatus {
  APPROVED
  PENDING
  REJECTED
}

enum OrderStatus {
  PENDING
  PARTIALLY_ACCEPTED
  ACCEPTED
  PROCESSING
  OUT_FOR_DELIVERY
  DELIVERED
  REJECTED
  CANCELLED
}

enum DeliveryType {
  STANDARD
  EXPRESS
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  PICKUP_IN_PROGRESS
  EN_ROUTE
  DELIVERED
}

enum DeliveryConfirmationMethod {
  PHOTO
  OTP
}

model User {
  id              BigInt     @id @default(autoincrement()) @db.UnsignedBigInt
  email           String     @unique @db.VarChar(255)
  password        String     @db.VarChar(255)
  role            UserRole   @default(PATIENT)
  status          UserStatus @default(ACTIVE)
  name            String     @db.VarChar(255)
  phoneNumber     String     @map("phone_number") @db.VarChar(255)
  dateOfBirth     DateTime?  @db.Date()
  profileImageUrl String?    @map("profile_image_url") @db.VarChar(255)
  createdAt       DateTime   @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt       DateTime   @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  pharmacy           Pharmacy?        @relation("PharmacyOwner")
  verifiedPharmacies Pharmacy[]       @relation("PharmacyVerifier")
  driver             Driver?          @relation("DriverOwner")
  verifiedDrivers    Driver[]         @relation("DriverVerifier")
  addresses          PatientAddress[]
  orders             Order[]

  @@index([role], map: "idx_users_role")
  @@index([status], map: "idx_users_status")
  @@map("users")
}

model Pharmacy {
  id                 BigInt             @id @default(autoincrement()) @db.UnsignedBigInt
  userId             BigInt             @unique @db.UnsignedBigInt
  verifiedBy         BigInt?            @db.UnsignedBigInt
  pharmacyName       String             @map("pharmacy_name") @db.VarChar(255)
  licenseNumber      String             @unique @map("license_number") @db.VarChar(255)
  licenseDocumentUrl String?            @map("license_document_url") @db.VarChar(255)
  city               String             @db.VarChar(255)
  address            String             @db.Text
  latitude           Decimal?           @db.Decimal(10, 8)
  longitude          Decimal?           @db.Decimal(11, 8)
  coverImageUrl      String?            @map("cover_image_url") @db.VarChar(255)
  verificationStatus VerificationStatus @default(UNDER_REVIEW) @map("verification_status")
  verifiedAt         DateTime?          @map("verified_at") @db.Timestamp()
  workOpenTime       DateTime?          @map("work_open_time") @db.Time()
  workCloseTime      DateTime?          @map("work_close_time") @db.Time()
  avgPrepTimeMinutes Int                @default(10) @map("avg_prep_time_minutes") @db.TinyInt
  createdAt          DateTime           @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt          DateTime           @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  // owner (1–1)
  user           User            @relation("PharmacyOwner", fields: [userId], references: [id])
  // verifier (admin, 1–many)
  admin          User?           @relation("PharmacyVerifier", fields: [verifiedBy], references: [id])
  inventoryItems InventoryItem[]

  @@index([verificationStatus], map: "idx_pharmacies_verified")
  @@index([city], map: "idx_pharmacies_cities")
  @@map("pharmacies")
}

model Driver {
  id                 BigInt             @id @default(autoincrement()) @db.UnsignedBigInt
  userId             BigInt             @unique @db.UnsignedBigInt
  verifiedBy         BigInt?            @db.UnsignedBigInt
  verifiedAt         DateTime?          @map("verified_at") @db.Timestamp()
  vehicleName        String             @map("vehicle_name") @db.VarChar(255)
  vehiclePlate       String             @unique @map("vehicle_plate") @db.VarChar(255)
  licenseDocumentUrl String             @map("license_document_url") @db.VarChar(255)
  currentCity        String             @map("current_city") @db.VarChar(255)
  currentArea        String?            @map("current_area") @db.VarChar(255)
  availabilityStatus AvailabilityStatus @default(OFFLINE) @map("availability_status")
  verificationStatus VerificationStatus @default(UNDER_REVIEW) @map("verification_status")
  createdAt          DateTime           @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt          DateTime           @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  user  User  @relation("DriverOwner", fields: [userId], references: [id])
  admin User? @relation("DriverVerifier", fields: [verifiedBy], references: [id])

  @@index([verificationStatus], map: "idx_drivers_verified")
  @@index([availabilityStatus], map: "idx_drivers_availability")
  @@index([currentCity], map: "idx_drivers_cities")
  @@map("drivers")
}

model Delivery {
  id        BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  createdAt DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt DateTime @updatedAt @map("updated_at") @db.DateTime(0)
}

model PatientAddress {
  id           BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  userId       BigInt   @db.UnsignedBigInt
  label        String?  @db.VarChar(255)
  area         String?  @db.VarChar(255)
  region       String?  @db.VarChar(255)
  country      String?  @db.VarChar(255)
  addressLine1 String   @db.Text
  addressLine2 String?  @db.Text
  latitude     Decimal? @db.Decimal(10, 8)
  longitude    Decimal? @db.Decimal(11, 8)
  isDefault    Boolean  @default(false) @map("is_default")
  isDeleted    Boolean  @default(false) @map("is_deleted")
  createdAt    DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.DateTime(0)
  //! Relations
  user         User     @relation(fields: [userId], references: [id])
  orders       Order[]

  @@index([userId], map: "idx_addresses_user")
  @@map("patient_addresses")
}

model CityDeliveryFee {
  id                BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  city              String   @unique @db.VarChar(255)
  standardFeeAmount Decimal  @default(0) @map("standard_fee_amount") @db.Decimal(10, 7)
  expressFeeAmount  Decimal? @map("express_fee_amount") @db.Decimal(10, 7)
  currency          String   @default("ILS") @db.Char(3)
  createdAt         DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.DateTime(0)

  @@map("city_delivery_fees")
}

model Category {
  id               BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  name             String   @db.VarChar(255)
  categoryImageUrl String?  @db.VarChar(255)
  description      String?  @db.MediumText
  createdAt        DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  medicines Medicine[]

  @@index([name], map: "idx_categories_name")
  @@map("categories")
}

model Medicine {
  id                   BigInt          @id @default(autoincrement()) @db.UnsignedBigInt
  categoryId           BigInt          @map("category_id") @db.UnsignedBigInt
  genericName          String          @map("generic_name") @db.VarChar(255)
  brandName            String?         @map("brand_name") @db.VarChar(255)
  manufacturer         String?         @db.VarChar(255)
  dosageForm           String?         @map("dosage_form") @db.VarChar(255)
  strengthValue        Decimal?        @map("strength_value") @db.Decimal(10, 7)
  strengthUnit         String?         @map("strength_unit") @db.VarChar(255)
  packSize             Int?            @map("pack_size") @db.Int
  packUnit             String?         @map("pack_unit") @db.VarChar(255)
  requiresPrescription Boolean         @default(false) @map("requires_prescription")
  activeIngredients    String?         @map("active_ingredients") @db.LongText
  dosageInstructions   String?         @map("dosage_instructions") @db.LongText
  storageInstructions  String?         @map("storage_instructions") @db.LongText
  warnings             String?         @db.LongText
  description          String          @db.LongText
  status               MedicineStatus  @default(PENDING)
  isActive             Boolean         @default(true) @map("is_active")
  maxPrice             Decimal?        @map("max_price") @db.Decimal(10, 8)
  createdAt            DateTime        @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt            DateTime        @updatedAt @map("updated_at") @db.DateTime(0)
  //! Relations
  category             Category        @relation(fields: [categoryId], references: [id])
  medicineImages       MedicineImage[]
  inventoryItems       InventoryItem[]

  @@index([categoryId, isActive, status], map: "idx_medicines_category_active_status")
  @@index([genericName], map: "idx_medicines_generic_name")
  @@index([brandName], map: "idx_medicines_brand_name")
  @@map("medicines")
}

model MedicineImage {
  id         BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  medicineId BigInt   @map("medicine_id") @db.UnsignedBigInt
  url        String   @db.VarChar(255)
  sortOrder  Int      @map("sort_order") @db.TinyInt
  createdAt  DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  medicine Medicine @relation(fields: [medicineId], references: [id])

  @@unique([medicineId, sortOrder], map: "uq_medicine_images_medicine_sort")
  @@index([medicineId], map: "idx_medicine_images_medicine_id")
  @@map("medicine_images")
}

model InventoryItem {
  id            BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  pharmacyId    BigInt    @map("pharmacy_id") @db.UnsignedBigInt
  medicineId    BigInt    @map("medicine_id") @db.UnsignedBigInt
  createdAt     DateTime  @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.DateTime(0)
  stockQuantity Int       @default(0) @map("stock_quantity") @db.Int
  minStock      Int       @default(0) @map("min_stock") @db.Int
  sellPrice     Decimal   @map("sell_price") @db.Decimal(10, 8)
  costPrice     Decimal?  @map("cost_price") @db.Decimal(10, 8)
  batchNumber   String?   @map("batch_number") @db.VarChar(255)
  expiryDate    DateTime? @map("expiry_date") @db.Date
  isAvailable   Boolean   @default(true) @map("is_available")
  notes         String?   @db.LongText
  shelfLocation String?   @map("shelf_location") @db.VarChar(255)
  isDeleted     Boolean   @default(false) @map("is_deleted")
  //! Relations
  medicine      Medicine  @relation(fields: [medicineId], references: [id])
  pharmacy      Pharmacy  @relation(fields: [pharmacyId], references: [id])

  @@unique([pharmacyId, medicineId], map: "uq_inventory_pharmacy_medicine")
  @@index([pharmacyId], map: "idx_inventory_pharmacy")
  @@index([medicineId], map: "idx_inventory_medicine")
  @@index([pharmacyId, expiryDate], map: "idx_inventory_pharmacy_expiry")
  @@map("inventory_items")
}

model Order {
  id        BigInt  @id @default(autoincrement()) @db.UnsignedBigInt
  patientId BigInt  @map("patient_id") @db.UnsignedBigInt
  addressId BigInt? @map("address_id") @db.UnsignedBigInt

  deliveryCity        String  @map("delivery_city") @db.VarChar(255)
  deliveryArea        String? @map("delivery_area") @db.VarChar(255)
  deliveryAddressLine String  @map("delivery_address_line") @db.Text

  contactName            String   @map("contact_name") @db.VarChar(255)
  contactPhone           String   @map("contact_phone") @db.VarChar(255)
  subtotalAmount         Decimal  @map("subtotal_amount") @db.Decimal(10, 7)
  originalSubtotalAmount Decimal? @map("original_subtotal_amount") @db.Decimal(10, 7)
  discountAmount         Decimal  @default(0) @map("discount_amount") @db.Decimal(10, 7)
  deliveryFeeAmount      Decimal  @default(0) @map("delivery_fee_amount") @db.Decimal(10, 7)
  totalAmount            Decimal  @map("total_amount") @db.Decimal(10, 7)
  originalTotalAmount    Decimal? @map("original_total_amount") @db.Decimal(10, 7)
  currency               String   @default("ILS") @db.Char(3)

  itemsCount         Int          @map("items_count") @db.Int
  originalItemsCount Int?         @map("original_items_count") @db.Int
  status             OrderStatus  @default(PENDING)
  deliveryType       DeliveryType @default(STANDARD) @map("delivery_type")
  notes              String?      @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt DateTime @updatedAt @map("updated_at") @db.DateTime(0)

  patient User            @relation(fields: [patientId], references: [id])
  address PatientAddress? @relation(fields: [addressId], references: [id])

  @@index([patientId, status], map: "idx_orders_patient_status")
  @@index([createdAt], map: "idx_orders_created_at")
  @@map("orders")
}
