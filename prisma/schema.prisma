generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

enum UserRole {
  PATIENT
  PHARMACY
  DRIVER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum VerificationStatus {
  UNDER_REVIEW
  VERIFIED
  REJECTED
}

enum AvailabilityStatus {
  ONLINE
  OFFLINE
}

model User {
  id              BigInt     @id @default(autoincrement()) @db.UnsignedBigInt
  email           String     @unique @db.VarChar(255)
  password        String     @db.VarChar(255)
  role            UserRole   @default(PATIENT)
  status          UserStatus @default(ACTIVE)
  name            String     @db.VarChar(255)
  phoneNumber     String     @map("phone_number") @db.VarChar(255)
  dateOfBirth     DateTime?  @db.Date()
  profileImageUrl String?    @map("profile_image_url") @db.VarChar(255)
  createdAt       DateTime   @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt       DateTime   @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  pharmacy           Pharmacy?        @relation("PharmacyOwner")
  verifiedPharmacies Pharmacy[]       @relation("PharmacyVerifier")
  driver             Driver?          @relation("DriverOwner")
  verifiedDrivers    Driver[]         @relation("DriverVerifier")
  addresses          PatientAddress[]

  @@index([role], map: "idx_users_role")
  @@index([status], map: "idx_users_status")
  @@map("users")
}

model Pharmacy {
  id                 BigInt             @id @default(autoincrement()) @db.UnsignedBigInt
  userId             BigInt             @unique @db.UnsignedBigInt
  verifiedBy         BigInt?            @db.UnsignedBigInt
  pharmacyName       String             @map("pharmacy_name") @db.VarChar(255)
  licenseNumber      String             @unique @map("license_number") @db.VarChar(255)
  licenseDocumentUrl String?            @map("license_document_url") @db.VarChar(255)
  city               String             @db.VarChar(255)
  address            String             @db.Text
  latitude           Decimal?           @db.Decimal(10, 8)
  longitude          Decimal?           @db.Decimal(11, 8)
  coverImageUrl      String?            @map("cover_image_url") @db.VarChar(255)
  verificationStatus VerificationStatus @default(UNDER_REVIEW) @map("verification_status")
  verifiedAt         DateTime?          @map("verified_at") @db.Timestamp()
  workOpenTime       DateTime?          @map("work_open_time") @db.Time()
  workCloseTime      DateTime?          @map("work_close_time") @db.Time()
  avgPrepTimeMinutes Int                @default(10) @map("avg_prep_time_minutes") @db.TinyInt
  createdAt          DateTime           @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt          DateTime           @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  // owner (1–1)
  user  User  @relation("PharmacyOwner", fields: [userId], references: [id])
  // verifier (admin, 1–many)
  admin User? @relation("PharmacyVerifier", fields: [verifiedBy], references: [id])

  @@index([verificationStatus], map: "idx_pharmacies_verified")
  @@index([city], map: "idx_pharmacies_cities")
  @@map("pharmacies")
}

model Driver {
  id                 BigInt             @id @default(autoincrement()) @db.UnsignedBigInt
  userId             BigInt             @unique @db.UnsignedBigInt
  verifiedBy         BigInt?            @db.UnsignedBigInt
  verifiedAt         DateTime?          @map("verified_at") @db.Timestamp()
  vehicleName        String             @map("vehicle_name") @db.VarChar(255)
  vehiclePlate       String             @unique @map("vehicle_plate") @db.VarChar(255)
  licenseDocumentUrl String             @map("license_document_url") @db.VarChar(255)
  currentCity        String             @map("current_city") @db.VarChar(255)
  currentArea        String?            @map("current_area") @db.VarChar(255)
  availabilityStatus AvailabilityStatus @default(OFFLINE) @map("availability_status")
  verificationStatus VerificationStatus @default(UNDER_REVIEW) @map("verification_status")
  createdAt          DateTime           @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt          DateTime           @updatedAt @map("updated_at") @db.DateTime(0)

  //! Relations
  user  User  @relation("DriverOwner", fields: [userId], references: [id])
  admin User? @relation("DriverVerifier", fields: [verifiedBy], references: [id])

  @@index([verificationStatus], map: "idx_drivers_verified")
  @@index([availabilityStatus], map: "idx_drivers_availability")
  @@index([currentCity], map: "idx_drivers_cities")
  @@map("drivers")
}

model Delivery {
  id BigInt @id @default(autoincrement()) @db.UnsignedBigInt
}

//   feat: add mapping  to CityDeliveryFees model in Prisma schema

model PatientAddress {
  id           BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  userId       BigInt   @db.UnsignedBigInt
  label        String?  @db.VarChar(255)
  area         String?  @db.VarChar(255)
  region       String?  @db.VarChar(255)
  country      String?  @db.VarChar(255)
  addressLine1 String   @db.Text
  addressLine2 String?  @db.Text
  latitude     Decimal? @db.Decimal(10, 8)
  longitude    Decimal? @db.Decimal(11, 8)
  isDefault    Boolean  @default(false) @map("is_default")
  isDeleted    Boolean  @default(false) @map("is_deleted")
  createdAt    DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.DateTime(0)
  //! Relations
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId], map: "idx_addresses_user")
  @@map("patient_addresses")
}

model CityDeliveryFees {
  id                BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  city              String   @unique @db.VarChar(255)
  standardFeeAmount Decimal  @default(0) @map("standard_fee_amount") @db.Decimal(10, 7)
  expressFeeAmount  Decimal? @map("express_fee_amount") @db.Decimal(10, 7)
  currency          String   @default("ILS") @db.Char(3)

  @@map("city_delivery_fees")
}
